# Pulse - Development Docker Compose
# Connects to local Supabase instance
#
# Prerequisites:
#   1. Start local Supabase first: npm run db:start
#   2. Then run: docker compose -f docker-compose.dev.yml up -d
#
# Access: http://localhost:3200

services:
  pulse:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Browser URL - embedded at build time, must be accessible from host browser
        NEXT_PUBLIC_SUPABASE_URL: http://localhost:54321
        NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
    container_name: pulse-dev
    restart: unless-stopped
    ports:
      - "3200:3000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - NODE_ENV=production
      # Server URL - used at runtime for server-side requests inside Docker
      - SUPABASE_SERVER_URL=http://host.docker.internal:54321
      - SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU
      - RESEND_API_KEY=${RESEND_API_KEY:-}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Cron service for scheduled health checks
  cron:
    image: alpine:3.19
    container_name: pulse-cron-dev
    restart: unless-stopped
    depends_on:
      pulse:
        condition: service_healthy
    command: >
      sh -c 'echo "* * * * * wget -q -O- http://pulse:3000/api/cron/check > /dev/null 2>&1" | crontab - && crond -f -l 2'
    network_mode: "service:pulse"
